<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
        <link rel="canonical" href="https://chileaddress.github.io/html/category/article-2627.htm" />
    <title>Spring cloud链路跟踪服务集成zipkin+mysql+sleuth+rabbitMq - Chile Address</title>
        <link href="/assets/addons/xcblog/css/chileaddress/bootstrap.css" rel="stylesheet" type="text/css" media="all">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <!-- Custom Theme files -->
    <link href="/assets/addons/xcblog/css/chileaddress/style.css" rel="stylesheet" type="text/css" media="all" />
    <!-- Custom Theme files -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/assets/addons/xcblog/img/chileaddress/favicon.ico" type="image/x-icon"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="application/x-javascript">
    addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false);

    function hideURLbar() { window.scrollTo(0, 1); }
    </script>
    <!--Google Fonts-->
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,500,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Condensed' rel='stylesheet' type='text/css'>
    <!--google fonts-->
    <script src="/assets/addons/xcblog/js/frontend/chileaddress/jquery-1.11.0.min.js"></script>
    <script src="/assets/addons/xcblog/js/frontend/chileaddress/bootstrap.min.js"></script>
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?e311768eec030d1b95bf25adcc77f433";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3332997411212854"
     crossorigin="anonymous"></script>
</head>

<body>
        <!--header-top start here-->
    <div class="top-header">
    </div>
    <!--header-top end here-->
    <!--header start here-->
    <!-- NAVBAR
		================================================== -->
    <div class="header w3l">
        <div class="fixed-header">
            <div class="navbar-wrapper">
                <div class="container">
                    <nav class="navbar navbar-inverse navbar-static-top">
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                            <div class="logo">
                                                                <a class="navbar-brand" href="/">Chile Address</a>
                                                            </div>
                        </div>
                        <div id="navbar" class="navbar-collapse collapse">
                            <nav class="cl-effect-16" id="cl-effect-16">
                                <ul class="nav navbar-nav">
                                                                        <li>
                                        <a href="/">首页</a>
                                    </li>
                                                                        <li>
                                        <a href="/html/category/">文章分类</a>
                                    </li>
                                                                        <li>
                                        <a href="#">关于</a>
                                    </li>
                                    <li>
                                        <a href="#">联系</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                        <div class="clearfix"> </div>
                    </nav>
                </div>
                <div class="clearfix"> </div>
            </div>
        </div>
    </div>
    <!--header end here-->
    <!--about strat here-->
    <div class="about">
        <div class="container">
            <div class="about-main">
                <div class="row">
                    <div class="col-md-9">
                        <ol class="breadcrumb">
                          <li><a href="/">首页</a></li>
                          <li><a href="/html/category/">文章分类</a></li>
                          <li class="active">正文</li>
                        </ol>
                        <div class="about-top">
                            <h1>Spring cloud链路跟踪服务集成zipkin+mysql+sleuth+rabbitMq</h1>
                        </div>
                        <div class="about-bottom">
                              				  				  				<div id="content_views" class="markdown_views prism-atom-one-dark"> <h2>Spring cloud链路跟踪服务集成zipkin+mysql+sleuth+rabbitMq</h2> <h4>一、链路跟踪服务能为我们带来什么好处？</h4> <p> 随着各模块单体微服务越来越多，系统之间的服务依赖、服务调用越来越复杂，当我们的系统出现性能缓慢时，无法快速地定位是哪个服务造成的，而链路跟踪服务能帮助我们很好的查看各服务调用信息，帮助我们很好地分析系统性能问题。</p> <h4>二、请求调用链路信息需不需要作数据存储？</h4> <p> 由于有的生产问题可能无法复现，所以请求调用链路信息是有必要作数据存储地，但是不能所有的信息都去存储，需要制定相关策略。</p> <h4>三、技术选型</h4> <p> 因为链路跟踪服务是辅助服务，不是我们的主流程服务，所以选型不要过于复杂，需要适配spring cloud体系。</p> <p>这里选用spring cloud全家桶里的组件，如下：</p> <p>spring-cloud-sleuth：用作服务之间调用信息采集。</p> <p>zipkin：用于图形化查看请求调用信息与服务之间的调用依赖关系。</p> <p>mysql：用于存储请求调用信息。</p> <p>rabbitmq：用于服务调用时给zipkin服务发送信息，在图形化界面查看调用信息，还支持web方式发送，但是web方式会占带宽影响系统性能，所以采用rabbitmq异步发送。</p> <h4>四、实现方案</h4> <p> 官方建议zipkin 2.0之后的版本用官方jar包；而zipkin没有提供存储策略，即数据要么全部存储，要么全部不存储。所以为了增加存储策略，不采用官方jar，自己定制zipkin服务。</p> <p>定制内容：</p> <p> 增加定时任务，定时删除请求响应小于N秒的请求，N支持配置。</p> <h4>五、配置文件详解</h4> <p>1、zipkin服务端配置文件</p> <p>application.yml</p> <pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span><span class="token key atrule">port</span><span class="token punctuation">:</span><span class="token number">9411</span><span class="token key atrule">spring</span><span class="token punctuation">:</span><span class="token key atrule">main</span><span class="token punctuation">:</span><span class="token key atrule">allow-bean-definition-overriding</span><span class="token punctuation">:</span><span class="token boolean important">true</span><span class="token key atrule">application</span><span class="token punctuation">:</span><span class="token key atrule">name</span><span class="token punctuation">:</span> zipkin<span class="token punctuation">-</span>server<span class="token key atrule">cloud</span><span class="token punctuation">:</span><span class="token key atrule">nacos</span><span class="token punctuation">:</span><span class="token key atrule">discovery</span><span class="token punctuation">:</span><span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.103.240<span class="token punctuation">:</span><span class="token number">8848</span><span class="token key atrule">cluster-name</span><span class="token punctuation">:</span> DEFAULT<span class="token key atrule">zipkin</span><span class="token punctuation">:</span><span class="token key atrule">enabled</span><span class="token punctuation">:</span><span class="token boolean important">true</span><span class="token comment">#启用zipkin</span><span class="token key atrule">discovery-client-enabled</span><span class="token punctuation">:</span><span class="token boolean important">false</span><span class="token comment">#服务端不注册zipkin服务</span><span class="token key atrule">sleuth</span><span class="token punctuation">:</span><span class="token key atrule">enabled</span><span class="token punctuation">:</span><span class="token boolean important">false</span><span class="token comment">#服务端不进行信息采集</span><span class="token comment">#数据库配置</span><span class="token key atrule">datasource</span><span class="token punctuation">:</span><span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver     		schema<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/zipkin.sql<span class="token comment">#服务启动执行脚本自动创建表结构</span><span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.103.240<span class="token punctuation">:</span>13126/cbs_svr_zipkin<span class="token punctuation">?</span>zeroDateTimeBehavior=CONVERT_TO_NULL<span class="token important">&allowMultiQueries</span>=true<span class="token important">&useUnicode</span>=true<span class="token important">&characterEncoding</span>=UTF<span class="token punctuation">-</span>8<span class="token important">&useSSL</span>=false<span class="token important">&serverTimezone</span>=GMT%2b8<span class="token important">&allowPublicKeyRetrieval</span>=true<span class="token key atrule">username</span><span class="token punctuation">:</span> root<span class="token key atrule">password</span><span class="token punctuation">:</span> q<span class="token tag">!W</span><span class="token comment">#3e4r123456</span><span class="token key atrule">initialization-mode</span><span class="token punctuation">:</span> always<span class="token key atrule">continueOnError</span><span class="token punctuation">:</span><span class="token boolean important">true</span><span class="token key atrule">zipkin</span><span class="token punctuation">:</span><span class="token comment">#配置rabbitmq</span><span class="token key atrule">collector</span><span class="token punctuation">:</span><span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span><span class="token key atrule">addresses</span><span class="token punctuation">:</span> 192.168.103.240<span class="token punctuation">:</span><span class="token number">5672</span><span class="token key atrule">username</span><span class="token punctuation">:</span> comtom<span class="token key atrule">password</span><span class="token punctuation">:</span> comtom<span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> cbs<span class="token comment">#指定数据库类型</span><span class="token key atrule">storage</span><span class="token punctuation">:</span><span class="token key atrule">type</span><span class="token punctuation">:</span> mysql<span class="token comment">#此配置不影响信息采集，若不配置，会报一个错误，但不影响服务采集信息，配置上时为了避免打印报错日志</span><span class="token key atrule">management</span><span class="token punctuation">:</span><span class="token key atrule">metrics</span><span class="token punctuation">:</span><span class="token key atrule">web</span><span class="token punctuation">:</span><span class="token key atrule">server</span><span class="token punctuation">:</span><span class="token key atrule">auto-time-requests</span><span class="token punctuation">:</span><span class="token boolean important">false</span><span class="token comment">#配置请求响应用时多少秒内的链路需要删除,默认删除1S内的链路跟踪信息。    1S = 1000000</span><span class="token key atrule">time</span><span class="token punctuation">:</span><span class="token number">1000000</span></code></pre> <p>2、zipkin客户端配置文件</p> <pre><code class="prism language-yml"><span class="token comment">#链路跟踪配置</span><span class="token key atrule">zipkin</span><span class="token punctuation">:</span><span class="token key atrule">sender</span><span class="token punctuation">:</span><span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit<span class="token comment">#请求调用发送到服务端方式</span><span class="token key atrule">sleuth</span><span class="token punctuation">:</span><span class="token key atrule">sampler</span><span class="token punctuation">:</span><span class="token key atrule">percentage</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token comment"># 全局采样率，测试环境配置全采样，生产环境可以不配置，采用默认值0.1</span></code></pre> <p><strong>zipkin表结构</strong></p> <p>CREATE TABLE IF NOT EXISTS zipkin_spans (<br /><code>trace_id_high</code> BIGINT NOT NULL DEFAULT 0 COMMENT ‘If non zero, this means the trace uses 128 bit traceIds instead of 64 bit’,<br /><code>trace_id</code> BIGINT NOT NULL,<br /><code>id</code> BIGINT NOT NULL,<br /><code>name</code> VARCHAR(255) NOT NULL,<br /><code>parent_id</code> BIGINT,<br /><code>debug</code> BIT(1),<br /><code>start_ts</code> BIGINT COMMENT ‘Span.timestamp(): epoch micros used for endTs query and to implement TTL’,<br /><code>duration</code> BIGINT COMMENT ‘Span.duration(): micros used for minDuration and maxDuration query’<br /> ) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;</p> <pre><code>ALTER TABLE zipkin_spans ADD UNIQUE KEY(`trace_id_high`, `trace_id`, `id`) COMMENT 'ignore insert on duplicate'; ALTER TABLE zipkin_spans ADD INDEX(`trace_id_high`, `trace_id`, `id`) COMMENT 'for joining with zipkin_annotations'; ALTER TABLE zipkin_spans ADD INDEX(`trace_id_high`, `trace_id`) COMMENT 'for getTracesByIds'; ALTER TABLE zipkin_spans ADD INDEX(`name`) COMMENT 'for getTraces and getSpanNames'; ALTER TABLE zipkin_spans ADD INDEX(`start_ts`) COMMENT 'for getTraces ordering and range';  CREATE TABLE IF NOT EXISTS zipkin_annotations (   `trace_id_high` BIGINT NOT NULL DEFAULT 0 COMMENT 'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit',   `trace_id` BIGINT NOT NULL COMMENT 'coincides with zipkin_spans.trace_id',   `span_id` BIGINT NOT NULL COMMENT 'coincides with zipkin_spans.id',   `a_key` VARCHAR(255) NOT NULL COMMENT 'BinaryAnnotation.key or Annotation.value if type == -1',   `a_value` BLOB COMMENT 'BinaryAnnotation.value(), which must be smaller than 64KB',   `a_type` INT NOT NULL COMMENT 'BinaryAnnotation.type() or -1 if Annotation',   `a_timestamp` BIGINT COMMENT 'Used to implement TTL; Annotation.timestamp or zipkin_spans.timestamp',   `endpoint_ipv4` INT COMMENT 'Null when Binary/Annotation.endpoint is null',   `endpoint_ipv6` BINARY(16) COMMENT 'Null when Binary/Annotation.endpoint is null, or no IPv6 address',   `endpoint_port` SMALLINT COMMENT 'Null when Binary/Annotation.endpoint is null',   `endpoint_service_name` VARCHAR(255) COMMENT 'Null when Binary/Annotation.endpoint is null' ) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;  ALTER TABLE zipkin_annotations ADD UNIQUE KEY(`trace_id_high`, `trace_id`, `span_id`, `a_key`, `a_timestamp`) COMMENT 'Ignore insert on duplicate'; ALTER TABLE zipkin_annotations ADD INDEX(`trace_id_high`, `trace_id`, `span_id`) COMMENT 'for joining with zipkin_spans'; ALTER TABLE zipkin_annotations ADD INDEX(`trace_id_high`, `trace_id`) COMMENT 'for getTraces/ByIds'; ALTER TABLE zipkin_annotations ADD INDEX(`endpoint_service_name`) COMMENT 'for getTraces and getServiceNames'; ALTER TABLE zipkin_annotations ADD INDEX(`a_type`) COMMENT 'for getTraces'; ALTER TABLE zipkin_annotations ADD INDEX(`a_key`) COMMENT 'for getTraces'; ALTER TABLE zipkin_annotations ADD INDEX(`trace_id`, `span_id`, `a_key`) COMMENT 'for dependencies job';  CREATE TABLE IF NOT EXISTS zipkin_dependencies (   `day` DATE NOT NULL,   `parent` VARCHAR(255) NOT NULL,   `child` VARCHAR(255) NOT NULL,   `error_count` BIGINT,   `call_count` BIGINT ) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;  ALTER TABLE zipkin_dependencies ADD UNIQUE KEY(`day`, `parent`, `child`);</code></pre> <p><strong>pom依赖</strong></p> <p>zipkin服务端：<br /><strong>一、zipkin服务</strong><br /> pom文件加入一下依赖：</p> <pre><code>    <dependency>         <groupId>com.alibaba.cloud</groupId>         <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>     </dependency>     <dependency>         <groupId>io.zipkin.java</groupId>         <artifactId>zipkin-server</artifactId>         <version>2.12.3</version>         <!--排除日志，否则报错-->         <exclusions>             <exclusion>                 <artifactId>log4j-slf4j-impl</artifactId>                 <groupId>org.apache.logging.log4j</groupId>             </exclusion>         </exclusions>     </dependency>     <!-- zipkin 界面-->     <dependency>         <groupId>io.zipkin.java</groupId>         <artifactId>zipkin-autoconfigure-ui</artifactId>         <version>2.12.3</version>     </dependency>     <!-- zipkin 存储到数据库需要引入此类 -->     <dependency>         <groupId>io.zipkin.java</groupId>         <artifactId>zipkin-autoconfigure-storage-mysql</artifactId>         <version>2.12.3</version>     </dependency>     <dependency>         <groupId>mysql</groupId>         <artifactId>mysql-connector-java</artifactId>     </dependency>     <dependency>         <groupId>org.springframework.boot</groupId>         <artifactId>spring-boot-starter-jdbc</artifactId>     </dependency>     <!--&lt;!&ndash;包含spring-cloud-starter-sleuth和spring-cloud-sleuth-zipkin两个依赖&ndash;&gt;-->     <dependency>         <groupId>org.springframework.cloud</groupId>         <artifactId>spring-cloud-starter-zipkin</artifactId>     </dependency>     <!--连接rabbitmq并配置-->     <dependency>         <groupId>io.zipkin.java</groupId>         <artifactId>zipkin-autoconfigure-collector-rabbitmq</artifactId>         <version>2.12.3</version>     </dependency></code></pre> <p>zipkin客户端：</p> <pre><code>    <dependency>         <groupId>org.springframework.cloud</groupId>         <artifactId>spring-cloud-starter-zipkin</artifactId>     </dependency>     <!-- 使用消息的方式收集数据（使用rabbitmq） -->     <dependency>         <groupId>io.zipkin.java</groupId>         <artifactId>zipkin-autoconfigure-collector-rabbitmq</artifactId>         <version>2.12.3</version>     </dependency></code></pre> <p>链路采集：<br /><img decoding="async" src="http://img.555519.xyz/uploads/20221201/758760524593883c27869c8ff8cc617d.jpg" alt="Spring cloud链路跟踪服务集成zipkin+mysql+sleuth+rabbitMq"><br /><img decoding="async" src="http://img.555519.xyz/uploads/20221201/42ec6b249b132e0279e4afa2a0f48252.jpg" alt="Spring cloud链路跟踪服务集成zipkin+mysql+sleuth+rabbitMq"><br /><img decoding="async" src="http://img.555519.xyz/uploads/20221201/30275994f1feebbc77b34a5cfd7b1eba.jpg" alt="Spring cloud链路跟踪服务集成zipkin+mysql+sleuth+rabbitMq"></p> </div> 			                            <div class="clearfix"> </div>
                        </div>

                        <div class="col-md-12 mt-5">
                                                        <p>上一个：<a href="/html/category/article-2626.htm">C语言读取和存储bmp格式图片</a></p>
                                                        <p>下一个：<a href="/html/category/article-2628.htm">Python语法学习之进程间的通信方式_python_</a></p>
                                                    </div>

                                            </div>
                    <div class="col-md-3">
                        <div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">热门文章</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2"><a href="/html/category/article-7414.htm" title="广州宠物领养站 广州宠物领养站地址">广州宠物领养站 广州宠物领养站地址</a></li>
                        <li class="py-2"><a href="/html/category/article-7461.htm" title="开动物医院需要什么手续和条件（开设动物医院的条件有哪些?）">开动物医院需要什么手续和条件（开设动物医院的条件有哪些?）</a></li>
                        <li class="py-2"><a href="/html/category/article-5587.htm" title="正压式空气呼吸器的性能参数">正压式空气呼吸器的性能参数</a></li>
                        <li class="py-2"><a href="/html/category/article-6817.htm" title="动物防疫法所称动物防疫（动物防疫法所称动物防疫是指）">动物防疫法所称动物防疫（动物防疫法所称动物防疫是指）</a></li>
                        <li class="py-2"><a href="/html/category/article-5588.htm" title="动物医院诊疗范围有哪些项目要求（动物医院诊室）">动物医院诊疗范围有哪些项目要求（动物医院诊室）</a></li>
                        <li class="py-2"><a href="/html/category/article-7139.htm" title="老鸭汤料包哪个牌子好吃一点(老鸭汤料包哪个牌子好吃又实惠)">老鸭汤料包哪个牌子好吃一点(老鸭汤料包哪个牌子好吃又实惠)</a></li>
                        <li class="py-2"><a href="/html/category/article-6122.htm" title="兰州哪里有卖猫粮的（兰州哪里有卖狗粮的地方）">兰州哪里有卖猫粮的（兰州哪里有卖狗粮的地方）</a></li>
                        <li class="py-2"><a href="/html/category/article-6679.htm" title="猫粮所有品牌app下载大全（猫粮品牌十大排行知乎）">猫粮所有品牌app下载大全（猫粮品牌十大排行知乎）</a></li>
                        <li class="py-2"><a href="/html/category/article-4604.htm" title="成都宠物救助热线电话（成都市宠物救助站是24小时的吗）">成都宠物救助热线电话（成都市宠物救助站是24小时的吗）</a></li>
                        <li class="py-2"><a href="/html/category/article-7047.htm" title="兽医资格证考取条件（兽医资格证考取条件要求）">兽医资格证考取条件（兽医资格证考取条件要求）</a></li>
                    </ul>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">归纳</h3>
    </div>
    <div class="panel-body">
        <ul class="p-0 x-0" style="list-style: none;margin: 0;padding: 0;">
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">18</span> <a href="/html/date/2024-08/" title="2024-08 归档">2024-08</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">62</span> <a href="/html/date/2024-07/" title="2024-07 归档">2024-07</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">60</span> <a href="/html/date/2024-06/" title="2024-06 归档">2024-06</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">62</span> <a href="/html/date/2024-05/" title="2024-05 归档">2024-05</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">60</span> <a href="/html/date/2024-04/" title="2024-04 归档">2024-04</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">62</span> <a href="/html/date/2024-03/" title="2024-03 归档">2024-03</a></h4>
            </li>
                        <li class="py-2">
                <h4><span class="badge" style="float: right;">44</span> <a href="/html/date/2024-02/" title="2024-02 归档">2024-02</a></h4>
            </li>
                    </ul>
    </div>
</div>


                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--about end here-->
        <!--copy rights start here-->
    <div class="copy-rights">
        <div class="container">
            <div class="copy-rights-main">
                <p>
                    Chile Address 版权所有
                    <br />
                    Powered by WordPress
                </p>
            </div>
        </div>
    </div>
    <script>
    $(function() {
        $('.js_to').click(function(){
            var url = $(this).data('url');
            var code = $(this).data('code');
            url += code;

            window.open(url);
        })
    });
    </script>
</body>

</html>